<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>wangEditor demo list</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="__STATIC__/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="__CSS__/public.css">
    <link rel="stylesheet" type="text/css" href="__CSS__/showTravels.css">
    <script src="__STATIC__/layui/layui.js"></script>
    <script type="text/javascript" src = '__JS__/wangEditor.js'></script>
    <script type="text/javascript" src = '__JS__/jquery-3.2.1.min.js'></script>
</head>
<body>
<!--导航开始-->
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo layui-layout-left">
            <a href="#" class="nav_logo"></a>
        </div>
        <ul class="layui-nav layui-layout-left"  lay-filter="demo">
            <li class="layui-nav-item"><a href="#">首页</a></li>
            <li class="layui-nav-item "><a href="#">目的地</a></li>
            <li class="layui-nav-item"><a href="#">旅行商城<span class="layui-badge-dot"></span></a></li>
            <li class="layui-nav-item">
                <a href="javascript:;">社区</a>
                <dl class="layui-nav-child"> <!-- 二级菜单 -->
                    <dd><a href="#">结伴</a></dd>
                    <dd><a href="#">游记</a></dd>
                </dl>
            </li>
        </ul>
        <ul class="layui-nav layui-layout-right" id="nav_user"  lay-filter="nav_user">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                    贤心
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="">基本资料</a></dd>
                    <dd><a href="">安全设置</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a href="#" id="loginOut">注销</a></li>
        </ul>
    </div>
</div>
<!--导航结束-->
<div id="main">
    <div class="set_index">
        <img src="{$travel.image}" style="height: 100%;width: 100%">
        <div class="view_info" data-length="32">
            <div class="vi_con">
                <h1 data-length="32" class="headtext lh80" style="white-space: nowrap; word-wrap: normal;">{$travel.title}</h1>
                <input id="travelsid" style="display: none" value="{$travel.travelsid}">
            </div>
        </div>
    </div>
    <div class="view_title">
        <div class="vt_center">
            <!--顶-->
            <div class="ding">
                <a role="button"  class="up_act" title="顶" type="button" id="ding" value="{$travel.travelsid}">顶</a>
                <div class="num ">{$ding}</div>
            </div>
            <div class="person">
                <a class="per_pic">
                    <img src="{$travel.uIcon}" width="120" height="120">
                </a>
                <strong>
                    <a class="per_name" title="听听cheerup">{$travel.uname}</a>
                    <a href="#"  class="per_grade" title="LV.16">LV.{$travel.uintegral}</a>
                </strong>
                <div class="vc_time">
                    <span class="time">{$travel.time}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="view clearfix">
        <div class="travel_directory">
            <div class="tarvel_dir_list clearfix">
                <ul>
                    <li class="time">出发时间<span>/</span>{$travel.departure}<i></i></li>
                    <li class="people">目的地<span>/</span>{$travel.destination}</li>
                    <li class="day">出行天数<span>/</span>{$travel.days} 天</li>
                    <li class="cost">人均费用<span>/</span>{$travel.percapita}</li>
                </ul>
            </div>
        </div>
        <div class="content" id="showContent">
            {$travel.content}
        </div>
    <!--富文本-->
        <div id="div1" class="toolbar">
        </div>
        <div style="padding: 2px 0; color: #ccc"></div>
        <div id="div2" class="text"> <!--可使用 min-height 实现编辑区域自动增加高度-->
            <p>say something</p>
        </div>
        <button class="layui-btn layui-btn-primary" id="btn1" style="float: right"> <i class="layui-icon">&#xe642;</i>评论</button>
        <div class="clear" style="margin-bottom:  20px;"></div>
        <!--游记评论-->
        <div id="comDiv">

        </div>
        <div id="page"></div>
    </div>
</div>

</body>
    <script>
        // 导航
    layui.use('element', function(){
        var element = layui.element;
        element.on('nav(demo)', function(elem){
            console.log(elem); //得到当前点击的DOM对象
        });
        element.on('navDelete(nav_user)',function (elem) {
            console.log(elem);
        });
    });

    $("#loginOut").click(function () {
        $("#nav_user").hide();
    });

    // 富文本
        var E = window.wangEditor;
        var editor = new E('#div1', '#div2')
        editor.customConfig.menus = [
            'head',  // 标题
            'bold',  // 粗体
            'fontSize',  // 字号
            'fontName',  // 字体
            'italic',  // 斜体
            'underline',  // 下划线
            'strikeThrough',  // 删除线
            'foreColor',  // 文字颜色
            'quote',  // 引用
            'emoticon'  // 表情
        ];

        // 表情面板可以有多个 tab ，因此要配置成一个数组。数组每个元素代表一个 tab 的配置
        editor.create();

        //评论游记
        //获取content
        document.getElementById('btn1').addEventListener('click', function () {
            // 读取 html
            var content = editor.txt.html();
            var travelsid = $("#travelsid").val();
            $.ajax({
                url:"../travels/addCom",
                dataType:"json",
                type:"post",
                data:{content:content,travelsid:travelsid},
                success:function (res) {
                    layer.msg(res.message);
                }
            });

        }, false);

        //实例化layer 用作layer.msg
        layui.use('layer', function(){
            var layer = layui.layer;
        });
        //顶
        $("#ding").click(function () {
            var travelsid = $("#ding").attr('value');
            $.ajax({
                url:"../travels/ding",
                type:"post",
                dataType:"json",
                data:{travelsid:travelsid},
                success:function (res) {
                    if(res.code==205){
                        var countDing = res.data.countDing;
                        $(".num").html(countDing);
                        layer.msg(res.message);
                    }else{
                        layer.msg(res.message);
                    }
                }
            });
        });

        var travelsid = $("#travelsid").val();
        //获取评论总条数
        $.ajax({
            url:"../travels/getCountPage",
            type:"post",
            dataType:"json",
            data:{travelsid:travelsid},
            success:function (res) {
                if(res==0){
                    $("#comDiv").html("还没有评论");
                }else{
                    paged(res);
                }
            }
        });



        //分页
        function paged(countPage) {
            layui.use('laypage', function(){
                var laypage = layui.laypage;

                //执行一个laypage实例
                laypage.render({
                    elem: 'page' //注意，这里的 test1 是 ID，不用加 # 号
                    ,count: countPage //数据总数，从服务端得到
                    ,limit:1
                    ,jump: function(obj, first){
                        var travelsid = $("#travelsid").val();
                        //obj包含了当前分页的所有参数，比如：
                        console.log(obj);
                        console.log(obj.curr); //得到当前页，以便向服务端请求对应页的数据。
                        console.log(obj.limit); //得到每页显示的条数
                        $.ajax({
                            url:"../travels/comPage",
                            type:"post",
                            dataType:"json",
                            data:{travelsid:travelsid,curr:obj.curr,limit:obj.limit},
                            success:function (res) {
                                console.log(res);
                                showCom(res);
                            }
                        });
                        //首次不执行
                        if(!first){
                            //do something
                        }
                    }
                });
            });
        }

        function showCom(data) {
            $("#comDiv").empty();
            for(var i=0;i<data.length;i++){
                var comSingle = '<div class="cmt">\n' +
                    '            <div class="cmt-info">\n' +
                    '                <div class="cmt-photo">\n' +
                    '                    <img src=" '+data[i].uIcon+' ">\n' +
                    '                </div>\n' +
                    '                <div class="cmt-user">\n' +
                    '                    <a class="name">'+data[i].uname+'</a>\n' +
                    '                    <a class="level">LV'+data[i].uintegral+'</a>\n' +
                    '                </div>\n' +
                    '            </div>\n' +
                    '            <div class="cmt-con-wrap">\n' +
                    '                <div class="cmt-con">\n' +
                    '                    <div class="cmt-word">\n' +
                    '                        <p>'+data[i].content+'</p>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '                <div class="clear">\n' +
                    '                </div>\n' +
                    '                <div class="cmt-bot">\n' +
                    '                    <div class="time">'+data[i].time+'</div>\n' +
                    '                    <div class="option">\n' +
                    '                        <a role="button">删除</a>\n' +
                    '                    </div>\n' +
                    '                </div>\n' +
                    '            </div>\n' +
                    '        </div>';
                $("#comDiv").append(comSingle)
            }
        }
        var img = $(".content img");
        for(var i=0;i<img.length;i++){
            //获取src值
            var src = img[i].getAttribute('src');
            //赋值给lay-src
            img[i].setAttribute('lay-src',src);
            //删除src
            img[i].attributes.removeNamedItem("src");
        }



        //图片懒加载
        layui.use('flow', function(){
            var flow = layui.flow;
            //按屏加载图片
            flow.lazyimg({
                elem: '#showContent img'
            });
        });


</script>
</html>
